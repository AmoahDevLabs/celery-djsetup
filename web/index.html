<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Celery systemd Service Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f7f9fb;
      }
      .card {
        background-color: #ffffff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05),
          0 10px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
      }
      .code-area {
        background-color: #1e293b;
        color: #f0fdf4;
        font-family: "Fira Code", "Consolas", monospace;
        min-height: 250px;
      }
      /* Inline Toast */
      .inline-toast {
        display: none;
        background-color: #16a34a;
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
        margin-bottom: 8px;
        text-align: center;
        animation: fadein 0.3s ease-in-out, fadeout 0.3s ease-in-out 1.8s;
      }

      @keyframes fadein {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes fadeout {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="app" class="max-w-4xl mx-auto p-4 md:p-8">
      <header class="text-center mb-10">
        <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-2">
          Celery systemd Config Generator
        </h1>
        <p class="text-slate-600">
          Generate unit files for your Django project with safe defaults and
          auto-detection support.
        </p>
        <p style="color:blue"><a href="https://github.com/AmoahDevLabs">By: AmoahDevLabs</a></p>
      </header>

      <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Config Form -->
        <section class="card p-6 rounded-xl space-y-4">
          <h2 class="text-xl font-bold text-slate-700 border-b pb-2 mb-4">
            Configuration
          </h2>

          <div>
            <label
              for="projectName"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Project Name</label
            >
            <input
              id="projectName"
              value="nhwiren"
              oninput="generateConfigs()"
              class="w-full p-2 border rounded-lg"
            />
            <p class="text-xs text-slate-500 mt-1">
              Example: <code>nhwiren</code>
            </p>
          </div>

          <div>
            <label
              for="linuxUser"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Linux User</label
            >
            <input
              id="linuxUser"
              value="nana"
              oninput="generateConfigs()"
              class="w-full p-2 border rounded-lg"
            />
          </div>

          <div>
            <label
              for="projectDir"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Project Directory</label
            >
            <input
              id="projectDir"
              value="/opt/nhwiren"
              oninput="generateConfigs()"
              class="w-full p-2 border rounded-lg"
            />
            <p class="text-xs text-slate-500 mt-1">
              Auto-detects if left empty.
            </p>
          </div>

          <div>
            <label
              for="venvBin"
              class="block text-sm font-medium text-slate-700 mb-1"
              >VENV Bin Directory</label
            >
            <input
              id="venvBin"
              value="/opt/nhwiren/.venv/bin"
              oninput="generateConfigs()"
              class="w-full p-2 border rounded-lg"
            />
            <p class="text-xs text-slate-500 mt-1">
              Defaults to <code>${projectDir}/.venv/bin</code>
            </p>
          </div>

          <div>
            <label
              for="djangoSettings"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Django Settings File</label
            >
            <input
              id="djangoSettings"
              value="nhwiren.settings"
              oninput="generateConfigs()"
              class="w-full p-2 border rounded-lg"
            />
            <p class="text-xs text-slate-500 mt-1">
              Leave blank for auto-detection.
            </p>
          </div>

          <div>
            <label
              for="brokerService"
              class="block text-sm font-medium text-slate-700 mb-1"
              >Message Broker</label
            >
            <select
              id="brokerService"
              onchange="generateConfigs()"
              class="w-full p-2 border rounded-lg"
            >
              <option value="rabbitmq-server.service">RabbitMQ</option>
              <option value="redis.service">Redis</option>
            </select>
          </div>
        </section>

        <!-- Output -->
        <section class="lg:col-span-2 space-y-8">
          <!-- Worker Config -->
          <div class="card p-6 rounded-xl">
            <h2
              class="text-xl font-bold text-slate-700 border-b pb-2 mb-4 flex justify-between items-center"
            >
              <span>celery-worker.service</span>
              <div class="text-right">
                <div id="toast-worker" class="inline-toast">Copied!</div>
                <button
                  onclick="copyToClipboard('workerConfig', 'toast-worker')"
                  class="px-3 py-1 bg-blue-600 text-white rounded-lg"
                >
                  Copy
                </button>
              </div>
            </h2>
            <textarea
              id="workerConfig"
              readonly
              class="code-area w-full p-3 rounded-lg"
            ></textarea>
          </div>

          <!-- Beat Config -->
          <div class="card p-6 rounded-xl">
            <h2
              class="text-xl font-bold text-slate-700 border-b pb-2 mb-4 flex justify-between items-center"
            >
              <span>celery-beat.service</span>
              <div class="text-right">
                <div id="toast-beat" class="inline-toast">Copied!</div>
                <button
                  onclick="copyToClipboard('beatConfig', 'toast-beat')"
                  class="px-3 py-1 bg-blue-600 text-white rounded-lg"
                >
                  Copy
                </button>
              </div>
            </h2>
            <textarea
              id="beatConfig"
              readonly
              class="code-area w-full p-3 rounded-lg"
            ></textarea>
          </div>
        </section>
      </main>
    </div>

    <script>
      function showInlineToast(toastId) {
        const toast = document.getElementById(toastId);
        toast.style.display = "block";
        setTimeout(() => {
          toast.style.display = "none";
        }, 2000);
      }

      async function copyToClipboard(id, toastId) {
        const ta = document.getElementById(id);
        if (ta && ta.value) {
          try {
            await navigator.clipboard.writeText(ta.value);
            showInlineToast(toastId);
          } catch (err) {
            alert("Failed to copy content.");
          }
        }
      }

      function generateConfigs() {
        const project =
          document.getElementById("projectName").value || "myproject";
        const user = document.getElementById("linuxUser").value || "django";
        const dir =
          document.getElementById("projectDir").value || `/opt/${project}`;
        const venv =
          document.getElementById("venvBin").value || `${dir}/.venv/bin`;
        const broker =
          document.getElementById("brokerService").value ||
          "rabbitmq-server.service";
        const settings =
          document.getElementById("djangoSettings").value ||
          `${project}.settings`;

        const celeryBin = `${venv}/celery`;
        const logDir = `/var/log/celery`;
        const runDir = `/var/run/celery`;

        const worker = `[Unit]
Description=Celery Worker for ${project}
After=network.target ${broker}
Requires=${broker}

[Service]
Type=simple
User=${user}
Group=${user}
WorkingDirectory=${dir}
Environment="DJANGO_SETTINGS_MODULE=${settings}"
ExecStartPre=/bin/mkdir -p ${logDir} ${runDir}
ExecStartPre=/bin/chown -R ${user}:${user} ${logDir} ${runDir}
ExecStart=${celeryBin} -A ${project} worker --loglevel=INFO --logfile=${logDir}/${project}-worker.log --pidfile=${runDir}/${project}-worker.pid
Restart=always
LimitNOFILE=10000

[Install]
WantedBy=multi-user.target`;

        const beat = `[Unit]
Description=Celery Beat Scheduler for ${project}
After=network.target ${broker}
Requires=${broker}

[Service]
Type=simple
User=${user}
Group=${user}
WorkingDirectory=${dir}
Environment="DJANGO_SETTINGS_MODULE=${settings}"
ExecStartPre=/bin/mkdir -p ${logDir} ${runDir}
ExecStartPre=/bin/chown -R ${user}:${user} ${logDir} ${runDir}
ExecStart=${celeryBin} -A ${project} beat --loglevel=INFO --logfile=${logDir}/${project}-beat.log --pidfile=${runDir}/${project}-beat.pid
Restart=always

[Install]
WantedBy=multi-user.target`;

        document.getElementById("workerConfig").value = worker;
        document.getElementById("beatConfig").value = beat;
      }

      window.onload = generateConfigs;
    </script>
  </body>
</html>

